<app-crud-generic
  componentTitle="Conceptos de Interés"
  [columns]="columns"
  [formFields]="formFields"
  [servicio]="conceptosService"
  [itemDefault]="itemDefault"
  dialogTitle="Gestión de Conceptos de Interés"
>
  <!-- Este template reemplaza al form genérico -->
  <ng-template
    #dialogForm
    let-form="form"
    let-submit="submit"
    let-cancel="cancel"
    let-modoEdicion="modoEdicion"
  >
    <div class="wizard-container">
      <!-- Step indicators -->
      <div class="steps">
        <div [class.active]="step === 1">1. Datos básicos</div>
        <div [class.active]="step === 2">2. Descripción</div>
        <div [class.active]="step === 3">3. Keywords</div>
        <div [class.active]="step === 4">4. Revisión</div>
      </div>

      <!-- STEP 1: nombre + área -->
      <form *ngIf="!modoEdicion && step === 1" [formGroup]="wizardForm">
        <label>Área</label>
        <select formControlName="areaId">
          <option *ngFor="let a of areas | async" [value]="a._id">
            {{ a.nombre }}
          </option>
        </select>

        <label>Nombre del Concepto</label>
        <input type="text" formControlName="nombre" />

        <div class="buttons">
          <button (click)="onCreateName()">Siguiente</button>
          <button (click)="cancel()">Cancelar</button>
        </div>
      </form>

      <!-- STEP 2: generar y editar descripción -->
      <form *ngIf="!modoEdicion && step === 2" [formGroup]="wizardForm">
        <textarea formControlName="descripcion" rows="6"></textarea>
        <div class="buttons">
          <button (click)="onGenerateKeywords()">Siguiente</button>
          <button (click)="step = 1">Atrás</button>
        </div>
      </form>

      <!-- STEP 3: lista y edición de keywords -->
      <div *ngIf="!modoEdicion && step === 3">
        <ul>
          <li *ngFor="let kw of keywordsList; let i = index">
            <input [(ngModel)]="keywordsList[i].nombre" />
            <button (click)="removeKeyword(i)">X</button>
          </li>
        </ul>
        <input #newKw placeholder="Nueva keyword" />
        <button (click)="addKeyword(newKw.value); newKw.value = ''">
          Añadir
        </button>

        <div class="buttons">
          <button (click)="onReview()">Siguiente</button>
          <button (click)="step = 2">Atrás</button>
        </div>
      </div>

      <!-- STEP 4 & EDIT MODE: revisión y confirmación -->
      <div *ngIf="(modoEdicion && step === 4) || (!modoEdicion && step === 4)">
        <p><strong>Área:</strong> {{ getAreaName(wizardForm.value.areaId) }}</p>
        <p><strong>Nombre:</strong> {{ wizardForm.value.nombre }}</p>
        <p><strong>Descripción:</strong></p>
        <p>{{ wizardForm.value.descripcion }}</p>
        <p><strong>Keywords:</strong></p>
        <ul>
          <li *ngFor="let kw of keywordsList">{{ kw.nombre }}</li>
        </ul>

        <div class="buttons">
          <button (click)="finish()">Terminar</button>
          <button (click)="step = modoEdicion ? 4 : 3">Atrás</button>
        </div>
      </div>
    </div>
  </ng-template>
</app-crud-generic>
